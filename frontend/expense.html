<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>expense</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <section class="container">
        <header>Expenses</header>
        <form class="form" onsubmit="savetolocalstorage(event)">
           <div class="input-box">
            <label for="expense">Expense</label>
            <input type="number" id="expense" name="expense" placeholder="enter expense">
           </div>
           <div class="input-box">
            <label for="description">Description</label>
            <input type="text" name="description" id="description" placeholder="enter description">
           </div>
           <div class="input-box">
            <label for="category">Category</label>
            <select name="category" id="category">
                <option value="select">select</option>
                <option value="food">food</option>
                <option value="petrol">petrol</option>
                <option value="party">party</option>
                <option value="rent">rent</option>
            </select>
            </div>
            <button type="submit">Add Expense</button>
        </form>
        <div>
            <button id="rzp-button1" type="submit">Buy premium</button>
            <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
        </div>
        <div id="message"></div>
        <div id="leaderboard"></div>
    </section>
<div id="listofitem"></div>
<div id="leaderboard_id"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
<script>

//show Leaderboard On screen

function showOnLeaderboard(){
try{
    const inputEle = document.createElement('input');
inputEle.value = "Show Leaderboard";
inputEle.type = "button";
inputEle.onclick = async (e)=>{
    const token = localStorage.getItem('token');  
    const leaderboard_list = await axios.get("http://localhost:3000/leaderboard",{headers:{"Authorization":token}});

    var leaderboardEle = document.getElementById('leaderboard_id');
    leaderboardEle.innerHTML += '<h1>Leader Board</h1>';

    leaderboard_list.data.forEach(element => {
        leaderboardEle.innerHTML += `<li>Name - ${element.name} TotalExpense - ${element.totalExpense}</li>`;
    });

    }
    document.getElementById('message').innerHTML = "you are a premium user";
    document.getElementById('message').appendChild(inputEle);

}catch(err){
console.log(err);
}

}

//  buy premium button function 

document.getElementById('rzp-button1').onclick = async function(e){
    const  token = localStorage.getItem('token');
    const response = await axios.get("http://localhost:3000/get_order",{headers:{"Authorization":token}})
    
    var option = {
        "key": response.data.key_id,
        "order_id":response.data.order.id,

        "handler": async function(response){
           await axios.post("http://localhost:3000/post_order",{
            order_id : option.order_id,
            payment_id : response.razorpay_payment_id,
           },{headers:{"authorization":token}}) 

           alert("you are a Premium User Now")
          document.getElementById('rzp-button1').style.visibility = 'hidden';
        showOnLeaderboard();
        } 
    }
    const rzp1 = new Razorpay(option);
    rzp1.open();
    e.preventDefault();

    rzp1.on('payment.failed', function(response){
        console.log(response);
        alert("Something went wrong");
    })

}

    //  save expenses in database

   async function savetolocalstorage(e)
    {
        try{
            e.preventDefault();
        const expense = e.target.expense.value;
        const description = e.target.description.value;
        const category = e.target.category.value;

        const obj = {
            expense,
            description,
            category
        }
        const token = localStorage.getItem('token');
       await axios.post("http://localhost:3000/expense" , obj  , {headers:{"Authorization":token}})
       showOnScreen(obj);

        }catch(err){
            console.log(err);
        }    
    }

            // show expenses on screen

    function showOnScreen(obj)
    {  try{
        const parentEle = document.getElementById('listofitem');
       const childEle = document.createElement('li');
       childEle.textContent = `${obj.expense}-${obj.description}-${obj.category}`;
       
       const deleteBtn = document.createElement('input');
       deleteBtn.type = "submit";
       deleteBtn.value = "Delete";
       childEle.appendChild(deleteBtn);

       deleteBtn.onclick = (req,res)=>{
        const token = localStorage.getItem('token');
        axios.delete(`http://localhost:3000/delete_expense/${obj.id}`,{headers:{"Authorization":token}}) 
        localStorage.removeItem(deleteBtn);
        parentEle.removeChild(childEle);
        }

         parentEle.append(childEle);
    }catch(err){
        res.status(501).json({err:err});
    }

    }

    window.addEventListener("DOMContentLoaded",async(req,res)=>{

    const token = localStorage.getItem('token');

        // show leaderboard button and hide buyPremium button on screen

    await axios.get("http://localhost:3000/ispremiumuser", {headers:{"Authorization":token}})
    .then((response)=>{
        if(response.data===true){
        document.getElementById('rzp-button1').style.visibility = 'hidden';
        showOnLeaderboard();
    }

    })
    .catch((err)=>{
        res.status(501).json({err:err});
    })

        // show expenses on screen

    await axios.get("http://localhost:3000/get_expenses", {headers:{"Authorization":token}})
    .then((result)=>{ 
        for(let i=0; i<result.data.length; i++){
             showOnScreen(result.data[i]);
        }
    })
    .catch((err)=>{
        res.status(502).json({err:err});
    })
   })
</script>
</body>
</html>